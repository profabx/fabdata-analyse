<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FabLabæ•°æ®åˆ†æå™¨ V2</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            background: white;
        }
        button {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .tables-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .table-header {
            background: #343a40;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        tr:hover {
            background: #f5f5f5;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }
        .countryStats {
            margin-bottom: 30px;
        }
        .format-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .mapping-suggestions {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .suggestions-content {
            padding: 20px;
        }
        .suggestion-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #007bff;
        }
        .suggestion-item.success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        .suggestion-item code {
            background: #e9ecef;
            padding: 5px 8px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #495057;
        }
        .unknown-stats {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
        }
        .stat-item {
            color: #495057;
            font-size: 14px;
        }
        .stat-item strong {
            color: #007bff;
        }
        .unknown-details {
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .unknown-details .stat-item {
            color: #856404;
            font-weight: 500;
        }
        @media (max-width: 768px) {
            .tables-section {
                grid-template-columns: 1fr;
            }
            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ FabLabæ•°æ®åˆ†æå™¨ V2</h1>
        
        <div class="input-section">
            <div class="input-group">
                <select id="yearFormat">
                    <option value="2016-2017">2016-2017 æ ¼å¼</option>
                    <option value="2018-2025">2018-2025 æ ¼å¼</option>
                </select>
                <input type="text" id="urlInput" placeholder="è¯·è¾“å…¥FabLabç½‘å€" value="https://archive.fabacademy.org/archives/2017/master/students.html">
                <button onclick="analyzeData()" id="analyzeBtn">åˆ†ææ•°æ®</button>
            </div>
            <div class="format-info">
                <strong>ğŸ“‹ æ•°æ®æ ¼å¼è¯´æ˜ï¼š</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li><strong>2016-2017æ ¼å¼ï¼š</strong> ä½¿ç”¨JSONæ•°æ®ï¼ŒåŒ…å«student_idã€firstã€lastç­‰å­—æ®µ</li>
                      <li>2016:https://archive.fabacademy.org/archives/2016/master/students.html</li>
                      <li>2017:https://archive.fabacademy.org/archives/2017/master/students.html</li>
                    <li><strong>2018-2025æ ¼å¼ï¼š</strong> ä½¿ç”¨HTMLé¡µé¢ï¼Œéœ€è¦è§£æHTMLç»“æ„</li>
                        <li>2018:https://fabacademy.org/2018/people.html</li>
                        <li>2019:https://fabacademy.org/2019/people.html</li>
                        <li>2020:https://fabacademy.org/2020/people.html</li>
                        <li>2021:https://fabacademy.org/2021/people.html</li>
                        <li>2022:https://fabacademy.org/2022/people.html</li>
                        <li>2023:https://fabacademy.org/2023/people.html</li>
                        <li>2024:https://fabacademy.org/2024/people.html</li>
                        <li>2025:https://fabacademy.org/2025/people.html</li>

             
                    
                </ul>
            </div>
            <!-- CORSè­¦å‘Šæ¡†å·²ç§»é™¤ï¼Œè‡ªåŠ¨å¯ç”¨ä»£ç†æœåŠ¡ -->
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>æ­£åœ¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div id="stats" class="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalLabs">0</div>
                <div class="stat-label">æ€»å®éªŒå®¤æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalStudents">0</div>
                <div class="stat-label">æ€»å­¦ç”Ÿæ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCountries">0</div>
                <div class="stat-label">å‚ä¸å›½å®¶æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="chinaLabs">0</div>
                <div class="stat-label">ä¸­å›½å®éªŒå®¤æ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="chinaStudents">0</div>
                <div class="stat-label">ä¸­å›½å­¦ç”Ÿæ•°é‡</div>
            </div>
        </div>

        <div id="countryStats" class="countryStats" style="display: none;">
            <div class="table-container">
                <div class="table-header">ğŸŒ å„å›½å­¦ç”Ÿç»Ÿè®¡</div>
                <table id="countryStatsTable">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å›½å®¶/åœ°åŒº</th>
                            <th>å­¦ç”Ÿæ•°é‡</th>
                            <th>å®éªŒå®¤æ•°é‡</th>
                            <th>å æ¯”</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="tables" class="tables-section" style="display: none;">
            <div class="table-container">
                <div class="table-header">ğŸ‡¨ğŸ‡³ ä¸­å›½å®éªŒå®¤</div>
                <table id="chinaLabsTable">
                    <thead>
                        <tr>
                            <th>å®éªŒå®¤åç§°</th>
                            <th>å›½å®¶/åœ°åŒº</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div class="table-container">
                <div class="table-header">ğŸ‘¨â€ğŸ“ ä¸­å›½å­¦ç”Ÿ</div>
                <table id="chinaStudentsTable">
                    <thead>
                        <tr>
                            <th>å­¦ç”Ÿå§“å</th>
                            <th>å®éªŒå®¤</th>
                            <th>å›½å®¶/åœ°åŒº</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- å‚ä¸å›½å®¶ç»Ÿè®¡è¡¨æ ¼å·²å…³é—­ -->
    </div>

    <script>
        let useProxyMode = false;
        
        // 2018-2025å¹´å®éªŒå®¤å¯¹åº”çš„å›½å®¶ä¿¡æ¯
        const labCountries2018 = {
            // 2018å¹´å®éªŒå®¤
            'barcelona': 'Spain',
            'fablabaachen': 'Germany',
            'fablabaalto': 'Finland',
            'fablabakgec': 'India',
            'fablabamsterdam': 'Netherlands',
            'fablabat3flo': 'France',
            'fablabbahrain': 'Bahrain',
            'fablabbeijing': 'China',
            'fablabberytech': 'Lebanon',
            'fablabbottrop': 'Germany',
            'fablabbrighton': 'UK',
            'fablabcept': 'India',
            'fablabcharlottelatin': 'USA',
            'fablabcrunchlab': 'Italy',
            'fablabdassault': 'USA',
            'falabdeusto': 'Spain',
            'fablabdigiscope': 'France',
            'fablabechofab': 'Canada',
            'fablabecostudio': 'Canada',
            'fablabegypt': 'Egypt',
            'fablaberfindergarden': 'Germany',
            'fablabesan': 'Peru',
            'fablabfct': 'Portugal',
            'fablabfacens': 'Brazil',
            'fablabgearbox': 'Kenya',
            'fablabincitefocus': 'USA',
            'fablabirbid': 'Jordan',
            'fablabisafjorour': 'Iceland',
            'fablabkamakura': 'Japan',
            'fablabkamplintfort': 'Germany',
            'fablabkhairpur': 'Pakistan',
            'fablabkochi': 'India',
            'fablabkromlaboro': 'Italy',
            'fablablccc': 'USA',
            'fablableon': 'UK',
            'fablabmadridceu': 'Spain',
            'fablabmexico': 'Mexico',
            'fablabodessa': 'USA',
            'fablabopendot': 'Italy',
            'fablaboshanghai': 'China',
            'fablaboulu': 'Finland',
            'fablabpuebla': 'Mexico',
            'fablabreykjavik': 'Iceland',
            'fablabrwanda': 'Rwanda',
            'fablabsantiago': 'Chile',
            'fablabseoul': 'South Korea',
            'fablabseoulinnovation': 'South Korea',
            'fablabsiena': 'Italy',
            'fablabsingapore': 'Singapore',
            'fablabsocom': 'USA',
            'fablabsorbonne': 'France',
            'fablabspinderihallerne': 'Denmark',
            'fablabszoil': 'China',
            // æ·»åŠ æ›´å¤šä¸­å›½å®éªŒå®¤
            'unncfablab': 'China',
            'litcheelab': 'China',
            'fablabunnc': 'China',
            'fablabningbo': 'China',
            'fablabchina': 'China',
            'fablabbeijing': 'China',
            'fablabshanghai': 'China',
            'fablabguangzhou': 'China',
            'fablabguangdong': 'China',
            'fablabguangzhou': 'China',
            'fablabguangdong': 'China',
            'fablabtechworks': 'Jordan',
            'fablabtecsup': 'Peru',
            'fablabtembisa': 'South Africa',
            'fablabtrivandrum': 'India',
            'fablabuae': 'UAE',
            'fablabulb': 'Belgium',
            'fablabutec': 'Peru',
            'fablabvigyanashram': 'India',
            'fablabvigyanasharm': 'India',  // å¯èƒ½çš„æ‹¼å†™é”™è¯¯
            'fablabwgtn': 'New Zealand',
            'fablabyachay': 'Ecuador',
            'fablabyucatan': 'Mexico',
            'fablabzoi': 'Ecuador',
            'farmlabalgarve': 'Portugal',
            'verket': 'Norway',
            'falabvestmannaeyjar': 'Iceland',
            
            // 2019å¹´å®éªŒå®¤
            'akgec': 'India',
            'aachen': 'Germany',
            'aalto': 'Finland',
            'algarve': 'Portugal',
            'bahrain': 'Bahrain',
            'bangalore': 'India',
            'barcelona': 'Spain',
            'berytech': 'Lebanon',
            'bottrop': 'Germany',
            'brighton': 'UK',
            'cept': 'India',
            'cit': 'Peru',
            'chandigarh': 'India',
            'charlottelatin': 'USA',
            'crunchlab': 'Italy',
            'dassault': 'USA',
            'dhahran': 'Saudi Arabia',
            'digiscope': 'France',
            'dilijan': 'Armenia',
            'esan': 'Peru',
            'fct': 'Portugal',
            'egypt': 'Egypt',
            'ied': 'Spain',
            'incitefocus': 'USA',
            'insper': 'Brazil',
            'irbid': 'Jordan',
            'kamakura': 'Japan',
            'kamplintfort': 'Germany',
            'kannai': 'Japan',
            'khairpur': 'Pakistan',
            'kochi': 'India',
            'lccc': 'USA',
            'lakazlab': 'Mauritius',
            'lamachinerie': 'France',
            'leon': 'Spain',
            'napoli': 'Italy',
            'oshanghai': 'China',
            'oulu': 'Finland',
            'polytech': 'Russia',
            'puebla': 'Mexico',
            'qbic': 'Qatar',
            'rwanda': 'Rwanda',
            'szoil': 'China',
            'santachiara': 'Italy',
            'seoul': 'South Korea',
            'singapore': 'Singapore',
            'sorbonne': 'France',
            'tecsup': 'Peru',
            'taipei': 'Taiwan',
            'trivandrum': 'India',
            'uae': 'UAE',
            'ulb': 'Belgium',
            'utec': 'Peru',
            'vancouver': 'Canada',
            'vigyanashram': 'India',
            'waag': 'Netherlands',
            'winam': 'Kenya',
            'zoi': 'Ecuador',
            'echofab': 'Canada',
            
            // 2020å¹´åŠä»¥åæ–°å¢çš„å®éªŒå®¤
            'amman': 'Jordan',
            'antioquia': 'Colombia',
            'beirut': 'Lebanon',
            'berlin': 'Germany',
            'bogota': 'Colombia',
            'boston': 'USA',
            'bristol': 'UK',
            'brussels': 'Belgium',
            'cairo': 'Egypt',
            'calgary': 'Canada',
            'cambridge': 'UK',
            'capetown': 'South Africa',
            'cardiff': 'UK',
            'chennai': 'India',
            'chicago': 'USA',
            'copenhagen': 'Denmark',
            'dallas': 'USA',
            'delhi': 'India',
            'dubai': 'UAE',
            'dublin': 'Ireland',
            'edinburgh': 'UK',
            'frankfurt': 'Germany',
            'geneva': 'Switzerland',
            'glasgow': 'UK',
            'gothenburg': 'Sweden',
            'hamburg': 'Germany',
            'helsinki': 'Finland',
            'hongkong': 'Hong Kong',
            'istanbul': 'Turkey',
            'jakarta': 'Indonesia',
            'johannesburg': 'South Africa',
            'karachi': 'Pakistan',
            'kolkata': 'India',
            'kuwait': 'Kuwait',
            'lagos': 'Nigeria',
            'lahore': 'Pakistan',
            'lausanne': 'Switzerland',
            'lille': 'France',
            'lima': 'Peru',
            'lisbon': 'Portugal',
            'london': 'UK',
            'losangeles': 'USA',
            'madrid': 'Spain',
            'manchester': 'UK',
            'manila': 'Philippines',
            'mexicocity': 'Mexico',
            'milan': 'Italy',
            'mumbai': 'India',
            'munich': 'Germany',
            'nairobi': 'Kenya',
            'newyork': 'USA',
            'nuremberg': 'Germany',
            'osaka': 'Japan',
            'oslo': 'Norway',
            'ottawa': 'Canada',
            'paris': 'France',
            'philadelphia': 'USA',
            'porto': 'Portugal',
            'prague': 'Czech Republic',
            'riodejaneiro': 'Brazil',
            'rome': 'Italy',
            'rotterdam': 'Netherlands',
            'saopaulo': 'Brazil',
            'seattle': 'USA',
            'shanghai': 'China',
            'stockholm': 'Sweden',
            'sydney': 'Australia',
            'telaviv': 'Israel',
            'tokyo': 'Japan',
            'toronto': 'Canada',
            'toulouse': 'France',
            'tunis': 'Tunisia',
            'vienna': 'Austria',
            'warsaw': 'Poland',
            'wellington': 'New Zealand',
            'zurich': 'Switzerland',
            
            // 2020å¹´ç‰¹å®šå®éªŒå®¤æ˜ å°„
            'agrilab': 'France',
            'algarvefarm': 'Portugal',
            'bhubaneswar': 'India',
            'chaihuoxfactory': 'China',
            'chaihuox': 'China',
            'chaihuo': 'China',
            'chaihuofactory': 'China',
            'chaihuolab': 'China',
            'chaihuofablab': 'China',
            'ciudaddemexico': 'Mexico',
            'dassaultsystemeslab': 'USA',
            'deusto': 'Spain',
            'dilijan': 'Armenia',
            'esan': 'Peru',
            'esne': 'Spain',
            'ecostudio': 'Panama',
            'fct': 'Portugal',
            'hrwbottrop': 'Germany',
            'incitefocus': 'USA',
            'irbid': 'Jordan',
            'kamakura': 'Japan',
            'kamplintfort': 'Germany',
            'kannai': 'Japan',
            'keralakochi': 'India',
            'khairpur': 'Pakistan',
            'lamachinerie': 'France',
            'leon': 'Spain',
            'loraincountycommunitycollege': 'USA',
            'newcairo': 'Egypt',
            'oshanghai': 'China',
            'opendot': 'Italy',
            'oulu': 'Finland',
            'qbic': 'Qatar',
            'reykjavik': 'Iceland',
            'rwanda': 'Rwanda',
            'szoil': 'China',
            'santachiara': 'Italy',
            'seoulinnovationlab': 'South Korea',
            'singaporepolytechnic': 'Singapore',
            'stjude': 'Costa Rica',
            'tecsup': 'Peru',
            'taipei': 'Taiwan',
            'talents': 'Saudi Arabia',
            'techworksamman': 'Jordan',
            'tinkerersfablabcastelldefels': 'Spain',
            'twardapoweredbyorange': 'Poland',
            'uae': 'UAE',
            'ucal': 'Peru',
            'ulb': 'Belgium',
            'vestmannaeyjar': 'Iceland',
            'vigyanashram': 'India',
            'waagamsterdam': 'Netherlands',
            'winam': 'Kenya',
            'yucatÃ¡n': 'Mexico',
            'zoi': 'Ecuador',
            'echofab': 'Canada',
            
            // 2021å¹´æ–°å¢å®éªŒå®¤æ˜ å°„
            'aalto': 'Finland',
            'amsterdam': 'Netherlands',
            'bangalore': 'India',
            'barcelona': 'Spain',
            'benfica': 'Portugal',
            'berytech': 'Lebanon',
            'bhubaneswarstpi': 'India',
            'chandigarh': 'India',
            'charlottelatin': 'USA',
            'ciudaddemexico': 'Mexico',
            'dassaultsystemeslab': 'USA',
            'digiscope': 'France',
            'dilijan': 'Armenia',
            'ecae': 'UAE',
            'esan': 'Peru',
            'egypt': 'Egypt',
            'fctfablab': 'Portugal',
            'hrwbottrop': 'Germany',
            'incitefocus': 'USA',
            'ingegnomakerspace': 'Belgium',
            'insper': 'Brazil',
            'ioannina': 'Greece',
            'irbid': 'Jordan',
            'kaust': 'Saudi Arabia',
            'kamakura': 'Japan',
            'kamplintfort': 'Germany',
            'kannai': 'Japan',
            'khairpur': 'Pakistan',
            'kochikerala': 'India',
            'lamachinerie': 'France',
            'leon': 'Spain',
            'libya': 'Libya',
            'lima': 'Peru',
            'loraincountycommunitycollege': 'USA',
            'napoli': 'Italy',
            'oshanghai': 'China',
            'opendot': 'Italy',
            'oulu': 'Finland',
            'plusxbrightonfablab': 'UK',
            'puebla': 'Mexico',
            'rwanda': 'Rwanda',
            'sedicupct': 'Spain',
            'santachiara': 'Italy',
            'singaporepolytechnic': 'Singapore',
            'tecsup': 'Peru',
            'taipei': 'Taiwan',
            'talents': 'Saudi Arabia',
            'techworksamman': 'Jordan',
            'uae': 'UAE',
            'ulb': 'Belgium',
            'ulimalaboratoriodefabricacionfablab': 'Peru',
            'vancouver': 'Canada',
            'vigyanashram': 'India',
            'wheatonfablab': 'USA',
            'yucatan': 'Mexico',
            'zoi': 'Ecuador',
            
            // è¡¥å……2020å¹´ç¼ºå¤±çš„å®éªŒå®¤æ˜ å°„
            'akgec': 'India',
            'bahrain': 'Bahrain',
            'bangalore': 'India',
            'barcelona': 'Spain',
            'chandigarh': 'India',
            'charlottelatin': 'USA',
            'crunchlab': 'Italy',
            'digiscope': 'France',
            'egypt': 'Egypt',
            'vigyanashram': 'India',
            'yucatn': 'Mexico',
            'chofab': 'Canada'
        };
        
        async function analyzeData() {
            const yearFormat = document.getElementById('yearFormat').value;
            const urlInput = document.getElementById('urlInput').value.trim();
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            const stats = document.getElementById('stats');
            const tables = document.getElementById('tables');
            const countryStats = document.getElementById('countryStats');

            if (!urlInput) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            analyzeBtn.disabled = true;
            loading.style.display = 'block';
            error.style.display = 'none';
            success.style.display = 'none';
            stats.style.display = 'none';
            tables.style.display = 'none';
            countryStats.style.display = 'none';

            try {
                let data;
                
                // é¦–å…ˆå°è¯•ä¸ä½¿ç”¨ä»£ç†
                useProxyMode = false;
                console.log('ğŸ”„ å°è¯•ç›´æ¥è·å–æ•°æ®...');
                
                try {
                    if (yearFormat === '2016-2017') {
                        data = await analyze2016Format(urlInput);
                    } else {
                        data = await analyze2018Format(urlInput);
                    }
                } catch (directError) {
                    console.log('ç›´æ¥è·å–å¤±è´¥ï¼Œå¯ç”¨ä»£ç†æœåŠ¡å™¨é‡è¯•...');
                    
                    // å¦‚æœç›´æ¥è·å–å¤±è´¥ï¼Œå¯ç”¨ä»£ç†é‡è¯•
                    useProxyMode = true;
                    loading.querySelector('p').textContent = 'æ­£åœ¨é€šè¿‡ä»£ç†æœåŠ¡å™¨è·å–æ•°æ®ï¼Œè¯·ç¨å€™...';
                    
                    if (yearFormat === '2016-2017') {
                        data = await analyze2016Format(urlInput);
                    } else {
                        data = await analyze2018Format(urlInput);
                    }
                }
                
                // åˆ†ææ•°æ®
                const analysis = analyzeFabLabData(data, yearFormat);
                
                // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                displayStats(analysis);
                
                // æ˜¾ç¤ºè¡¨æ ¼
                displayTables(analysis);
                
                // æ˜¾ç¤ºUnknownå­¦ç”Ÿå’Œå®éªŒå®¤ä¿¡æ¯
                displayUnknownInfo(analysis);
                
                // æ‰“å°åŠ¨æ€å›½å®¶æ˜ å°„è¡¨
                countryManager.printDynamicMapping();
                
                showSuccess('æ•°æ®åˆ†æå®Œæˆï¼');
                
            } catch (err) {
                console.error('è·å–æ•°æ®æ—¶å‡ºé”™:', err);
                let errorMessage = `è·å–æ•°æ®å¤±è´¥: ${err.message}`;
                
                // å¦‚æœæ˜¯CORSé”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„è§£å†³æ–¹æ¡ˆ
                if (err.message.includes('CORS') || err.message.includes('Failed to fetch')) {
                    errorMessage += '<br><br><strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>';
                    errorMessage += '1. æ£€æŸ¥ç½‘ç»œè¿æ¥<br>';
                    errorMessage += '2. ç¡®è®¤ç½‘å€æ ¼å¼æ­£ç¡®<br>';
                    errorMessage += '3. å°è¯•ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œæ­¤é¡µé¢';
                }
                
                showError(errorMessage);
            } finally {
                analyzeBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        async function analyze2016Format(url) {
            // æ„å»ºstudents.jsonçš„URL
            const baseUrl = url.replace('/students.html', '');
            let studentsJsonUrl = `${baseUrl}/students.json`;
            
            // å¦‚æœä½¿ç”¨ä»£ç†æ¨¡å¼ï¼Œé€šè¿‡ä»£ç†æœåŠ¡å™¨è·å–æ•°æ®
            if (useProxyMode) {
                studentsJsonUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(studentsJsonUrl)}`;
            }
            
            console.log('æ­£åœ¨è·å–2016-2017æ ¼å¼æ•°æ®:', studentsJsonUrl);
            
            const response = await fetch(studentsJsonUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            let data;
            if (useProxyMode) {
                // ä»£ç†æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ ¼å¼ä¸åŒ
                const proxyResponse = await response.json();
                if (proxyResponse.contents) {
                    data = JSON.parse(proxyResponse.contents);
                } else {
                    throw new Error('ä»£ç†æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } else {
                data = await response.json();
            }
            
            console.log('è·å–åˆ°çš„2016-2017æ•°æ®:', data);
            return data;
        }

        async function analyze2018Format(url) {
            console.log('æ­£åœ¨è·å–2018-2025æ ¼å¼æ•°æ®:', url);
            
            let fetchUrl = url;
            if (useProxyMode) {
                fetchUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
            }
            
            const response = await fetch(fetchUrl);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            let htmlContent;
            if (useProxyMode) {
                const proxyResponse = await response.json();
                if (proxyResponse.contents) {
                    htmlContent = proxyResponse.contents;
                } else {
                    throw new Error('ä»£ç†æœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
                }
            } else {
                htmlContent = await response.text();
            }
            
            // è§£æHTMLæ•°æ®
            const data = parse2018HTML(htmlContent);
            console.log('è§£æçš„2018-2025æ•°æ®:', data);
            return data;
        }

        function parse2018HTML(htmlContent) {
            const data = [];
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // æŸ¥æ‰¾æ‰€æœ‰å®éªŒå®¤ - æ”¯æŒå¤šç§HTMLç»“æ„
            let labHeaders = doc.querySelectorAll('h3 a');
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°h3 aï¼Œå°è¯•å…¶ä»–é€‰æ‹©å™¨
            if (labHeaders.length === 0) {
                labHeaders = doc.querySelectorAll('h3');
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•æ›´å®½æ³›çš„é€‰æ‹©å™¨
            if (labHeaders.length === 0) {
                labHeaders = doc.querySelectorAll('h3, h2, .lab-header');
            }
            
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•æ‰€æœ‰å¯èƒ½çš„æ ‡é¢˜å…ƒç´ 
            if (labHeaders.length === 0) {
                labHeaders = doc.querySelectorAll('h1, h2, h3, h4, h5, h6');
            }
            
            console.log('æ‰¾åˆ°çš„å®éªŒå®¤æ ‡é¢˜æ•°é‡:', labHeaders.length);
            console.log('HTMLç»“æ„:', doc.body.innerHTML.substring(0, 1000));
            
            console.log('æ‰¾åˆ°çš„å®éªŒå®¤æ ‡é¢˜æ•°é‡:', labHeaders.length);
            
            labHeaders.forEach((labHeader, index) => {
                let labName, labUrl;
                
                if (labHeader.tagName === 'A') {
                    labName = labHeader.textContent.trim();
                    labUrl = labHeader.getAttribute('href');
                } else {
                    // å¯¹äºh3å…ƒç´ ï¼ŒæŸ¥æ‰¾å…¶ä¸­çš„é“¾æ¥
                    const link = labHeader.querySelector('a');
                    if (link) {
                        labName = link.textContent.trim();
                        labUrl = link.getAttribute('href');
                    } else {
                        labName = labHeader.textContent.trim();
                        labUrl = '#';
                    }
                }
                
                // ä»URLæˆ–å®éªŒå®¤åç§°æå–å®éªŒå®¤æ ‡è¯†
                let labId = '';
                if (labUrl && labUrl !== '#') {
                    labId = labUrl.split('/').pop();
                } else {
                    // å¦‚æœæ²¡æœ‰URLï¼Œä»å®éªŒå®¤åç§°æå–æ ‡è¯†
                    labId = labName.toLowerCase().replace(/\s+/g, '').replace(/[^a-z]/g, '');
                }
                
                console.log(`å®éªŒå®¤ ${index + 1}: ${labName} (ID: ${labId})`);
                console.log(`  - åŸå§‹åç§°: "${labName}"`);
                console.log(`  - ç”Ÿæˆçš„ID: "${labId}"`);
                console.log(`  - URL: "${labUrl}"`);
                console.log(`  - å®éªŒå®¤å…ƒç´ ç±»å‹: ${labHeader.tagName}`);
                console.log(`  - å®éªŒå®¤å…ƒç´ å†…å®¹: ${labHeader.innerHTML}`);
                
                // æŸ¥æ‰¾è¯¥å®éªŒå®¤ä¸‹çš„æ‰€æœ‰å­¦ç”Ÿ
                let studentList = labHeader.parentElement.nextElementSibling;
                if (!studentList || studentList.tagName !== 'UL') {
                    // å°è¯•æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ 
                    studentList = labHeader.nextElementSibling;
                }
                
                if (studentList && studentList.tagName === 'UL') {
                    const students = studentList.querySelectorAll('li a');
                    console.log(`  - æ‰¾åˆ° ${students.length} ä¸ªå­¦ç”Ÿ`);
                    
                    students.forEach(studentLink => {
                        const studentName = studentLink.textContent.trim();
                        const studentCode = studentLink.getAttribute('data-code');
                        const studentUrl = studentLink.getAttribute('href');
                        
                        // ä»å®éªŒå®¤æ˜ å°„è¡¨è·å–å›½å®¶ä¿¡æ¯
                        let country = 'Unknown';
                        console.log(`  - å®éªŒå®¤ID: ${labId}, å®éªŒå®¤åç§°: ${labName}`);
                        
                        // é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…labId
                        if (labCountries2018[labId.toLowerCase()]) {
                            country = labCountries2018[labId.toLowerCase()];
                            console.log(`    - ç²¾ç¡®åŒ¹é…labId: ${labId} -> ${country}`);
                        } else {
                                                    // å°è¯•å¤šç§å¯èƒ½çš„åç§°æ ¼å¼
                        const possibleIds = [
                            labId.toLowerCase(),
                            labName.toLowerCase().replace(/\s+/g, ''),
                            labName.toLowerCase().replace(/\s+/g, '').replace(/[^a-z]/g, ''),
                            labName.toLowerCase().replace(/\s+/g, '').replace(/fablab/i, ''),
                            labName.toLowerCase().replace(/\s+/g, '').replace(/fablab\s*/i, ''),
                            // ç‰¹æ®Šå¤„ç†Vigyan Ashram
                            labName.toLowerCase().includes('vigyan') ? 'vigyanashram' : null,
                            labName.toLowerCase().includes('vigyan') ? 'fablabvigyanashram' : null,
                            // ç‰¹æ®Šå¤„ç†Chaihuo
                            labName.toLowerCase().includes('chaihuo') ? 'chaihuoxfactory' : null,
                            labName.toLowerCase().includes('chaihuo') ? 'chaihuox' : null,
                            labName.toLowerCase().includes('chaihuo') ? 'chaihuo' : null,
                            // å¤„ç†å¯èƒ½çš„å…¶ä»–Chaihuoå˜ä½“
                            labName.toLowerCase().includes('chaihuo') ? 'chaihuofactory' : null,
                            labName.toLowerCase().includes('chaihuo') ? 'chaihuolab' : null,
                            labName.toLowerCase().includes('chaihuo') ? 'chaihuofablab' : null,
                            // ç‰¹æ®Šå¤„ç†ä¸­å›½å®éªŒå®¤
                            labName.toLowerCase().includes('unnc') ? 'unncfablab' : null,
                            labName.toLowerCase().includes('litchee') ? 'litcheelab' : null,
                            labName.toLowerCase().includes('ningbo') ? 'fablabningbo' : null,
                            labName.toLowerCase().includes('shenzhen') ? 'litcheelab' : null,
                            labName.toLowerCase().includes('china') ? 'fablabchina' : null
                        ].filter(id => id !== null);
                            
                            let found = false;
                            console.log(`    - å°è¯•çš„IDåˆ—è¡¨: [${possibleIds.join(', ')}]`);
                            for (const possibleId of possibleIds) {
                                console.log(`    - å°è¯•ID: "${possibleId}" -> ${labCountries2018[possibleId] || 'æœªæ‰¾åˆ°'}`);
                                if (labCountries2018[possibleId]) {
                                    country = labCountries2018[possibleId];
                                    console.log(`    - å¤šæ ¼å¼åŒ¹é…æˆåŠŸ: ${possibleId} -> ${country}`);
                                    found = true;
                                    break;
                                }
                            }
                            
                            // å¦‚æœå¤šæ ¼å¼åŒ¹é…å¤±è´¥ï¼Œå°è¯•åŒ…å«åŒ¹é…
                            if (!found) {
                                for (const [key, value] of Object.entries(labCountries2018)) {
                                    if (labId.toLowerCase().includes(key.toLowerCase()) || 
                                        labName.toLowerCase().includes(key.toLowerCase())) {
                                        country = value;
                                        console.log(`    - åŒ…å«åŒ¹é…: ${key} -> ${country}`);
                                        break;
                                    }
                                }
                            }
                            
                            // å¦‚æœä»ç„¶æ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•ä»å®éªŒå®¤åç§°ä¸­ç›´æ¥æå–å›½å®¶ä¿¡æ¯
                            if (!found && country === 'Unknown') {
                                const extractedCountry = extractCountryFromLabName(labName);
                                if (extractedCountry !== 'Unknown') {
                                    country = extractedCountry;
                                    console.log(`    - ä»å®éªŒå®¤åç§°æå–å›½å®¶: ${labName} -> ${country}`);
                                }
                            }
                        }
                        
                        console.log(`    - å­¦ç”Ÿ: ${studentName} -> å›½å®¶: ${country}`);
                        
                        data.push({
                            name: studentName,
                            code: studentCode,
                            lab: labName,
                            lab_url: labUrl,
                            url: studentUrl,
                            country: country
                        });
                    });
                } else {
                    console.log(`  - æœªæ‰¾åˆ°å­¦ç”Ÿåˆ—è¡¨`);
                }
            });
            
            console.log('è§£æåˆ°çš„å®éªŒå®¤æ•°æ®:', data.slice(0, 5));
            return data;
        }

        function analyzeFabLabData(data, format) {
            const labs = new Set();
            const students = new Set();
            const chinaLabs = new Set();
            const chinaStudents = [];
            const chinaLabList = [];
            const countryCounter = new CountryCounter();

            // ä¸­å›½ç›¸å…³çš„å›½å®¶å’Œåœ°åŒº
            const chinaRegions = ['China', 'Taipei', 'Taiwan', 'Hong Kong', 'HongKong', 'Macao', 'Macau', 'Chinese'];

            console.log('åŸå§‹æ•°æ®æ ·æœ¬:', data.slice(0, 3));

            data.forEach((student, index) => {
                if (format === '2016-2017') {
                    // 2016-2017æ ¼å¼å¤„ç†
                    // ç»Ÿè®¡å®éªŒå®¤
                    if (student.lab_name && student.lab_name.trim()) {
                        labs.add(student.lab_name.trim());
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºä¸­å›½å®éªŒå®¤
                        if (student.country && chinaRegions.some(region => 
                            student.country.toLowerCase().includes(region.toLowerCase()))) {
                            chinaLabs.add(student.lab_name.trim());
                            
                            // æ·»åŠ åˆ°ä¸­å›½å®éªŒå®¤åˆ—è¡¨
                            const labInfo = {
                                name: student.lab_name.trim(),
                                country: student.country,
                                url: student.lab_url || '#'
                            };
                            
                            if (!chinaLabList.find(lab => lab.name === student.lab_name.trim())) {
                                chinaLabList.push(labInfo);
                            }
                        }
                    }

                    // æ”¹è¿›å­¦ç”Ÿç»Ÿè®¡é€»è¾‘ - ä½¿ç”¨æ›´å¯é çš„å”¯ä¸€æ ‡è¯†ï¼Œå¤„ç†é‡å¤student_idçš„æƒ…å†µ
                    let studentId = null;
                    if (student.student_id && student.student_id.trim()) {
                        // å¦‚æœæœ‰firstå’Œlaståå­—ï¼Œç»“åˆstudent_idåˆ›å»ºå”¯ä¸€æ ‡è¯†
                        if (student.first && student.last) {
                            studentId = `${student.student_id.trim()}_${student.first.trim()}_${student.last.trim()}`;
                        } else if (student.first) {
                            studentId = `${student.student_id.trim()}_${student.first.trim()}`;
                        } else if (student.last) {
                            studentId = `${student.student_id.trim()}_${student.last.trim()}`;
                        } else {
                            studentId = `${student.student_id.trim()}_${index}`;
                        }
                    } else if (student.id && student.id.trim()) {
                        studentId = student.id.trim();
                    } else if (student.first && student.last) {
                        studentId = `${student.first.trim()}_${student.last.trim()}`;
                    } else if (student.first) {
                        studentId = student.first.trim();
                    } else if (student.last) {
                        studentId = student.last.trim();
                    } else {
                        studentId = `student_${index}`;
                    }
                    
                    if (studentId) {
                        students.add(studentId);
                    }

                    // ç»Ÿè®¡å„å›½å­¦ç”Ÿæ•°é‡ - ä½¿ç”¨CountryCounter
                    if (student.country && student.country.trim()) {
                        const country = student.country.trim();
                        let studentName = 'æœªçŸ¥';
                        if (student.first && student.last) {
                            studentName = `${student.first} ${student.last}`;
                        } else if (student.name) {
                            studentName = student.name;
                        } else if (student.first) {
                            studentName = student.first;
                        } else if (student.last) {
                            studentName = student.last;
                        }
                        
                        countryCounter.addStudent(studentName, student.lab_name || 'æœªçŸ¥', country);
                    }

                    // æ£€æŸ¥æ˜¯å¦ä¸ºä¸­å›½å­¦ç”Ÿ
                    if (student.country && chinaRegions.some(region => 
                        student.country.toLowerCase().includes(region.toLowerCase()))) {
                        
                        // å°è¯•å¤šç§å¯èƒ½çš„å§“åå­—æ®µ
                        let studentName = 'æœªçŸ¥';
                        if (student.first && student.last) {
                            studentName = `${student.first} ${student.last}`;
                        } else if (student.name) {
                            studentName = student.name;
                        } else if (student.first) {
                            studentName = student.first;
                        } else if (student.last) {
                            studentName = student.last;
                        } else if (student.student_name) {
                            studentName = student.student_name;
                        } else if (student.full_name) {
                            studentName = student.full_name;
                        }
                        
                        // æ„å»ºæ­£ç¡®çš„å­¦ç”Ÿé“¾æ¥ - ä½¿ç”¨emailåœ°å€
                        let studentUrl = '#';
                        if (student.email) {
                            studentUrl = `mailto:${student.email}`;
                        } else if (student.url) {
                            studentUrl = student.url;
                        }
                        
                        chinaStudents.push({
                            name: studentName,
                            lab: student.lab_name || 'æœªçŸ¥',
                            country: student.country,
                            url: studentUrl
                        });
                    }
                } else {
                    // 2018-2025æ ¼å¼å¤„ç†
                    // ç»Ÿè®¡å®éªŒå®¤
                    if (student.lab && student.lab.trim()) {
                        labs.add(student.lab.trim());
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºä¸­å›½å®éªŒå®¤
                        if (student.country && chinaRegions.some(region => 
                            student.country.toLowerCase().includes(region.toLowerCase()))) {
                            chinaLabs.add(student.lab.trim());
                            
                            // æ·»åŠ åˆ°ä¸­å›½å®éªŒå®¤åˆ—è¡¨
                            const labInfo = {
                                name: student.lab.trim(),
                                country: student.country,
                                url: student.lab_url || '#'
                            };
                            
                            if (!chinaLabList.find(lab => lab.name === student.lab.trim())) {
                                chinaLabList.push(labInfo);
                            }
                        }
                    }

                    // å­¦ç”Ÿç»Ÿè®¡
                    let studentId = null;
                    if (student.code) {
                        studentId = student.code.trim();
                    } else if (student.name) {
                        studentId = student.name.trim();
                    } else {
                        studentId = `student_${index}`;
                    }
                    
                    if (studentId) {
                        students.add(studentId);
                    }

                    // ç»Ÿè®¡å„å›½å­¦ç”Ÿæ•°é‡ - ä½¿ç”¨CountryCounter
                    if (student.country && student.country.trim()) {
                        const country = student.country.trim();
                        countryCounter.addStudent(student.name || 'æœªçŸ¥', student.lab || 'æœªçŸ¥', country);
                    }

                    // æ£€æŸ¥æ˜¯å¦ä¸ºä¸­å›½å­¦ç”Ÿ
                    if (student.country && chinaRegions.some(region => 
                        student.country.toLowerCase().includes(region.toLowerCase()))) {
                        
                        chinaStudents.push({
                            name: student.name || 'æœªçŸ¥',
                            lab: student.lab || 'æœªçŸ¥',
                            country: student.country,
                            url: student.url || '#'
                        });
                    }
                }
            });

            // è·å–CountryCounterçš„ç»Ÿè®¡ç»“æœ
            const countryStatsData = countryCounter.getCountryStats();
            const countryStatsArray = Object.entries(countryStatsData)
                .map(([country, data]) => ({ 
                    country, 
                    count: data.count,
                    labs: data.labs,
                    students: data.students
                }))
                .sort((a, b) => b.count - a.count);

            console.log('ç»Ÿè®¡ç»“æœ:', {
                totalLabs: labs.size,
                totalStudents: students.size,
                totalCountries: countryCounter.getTotalCountries(),
                chinaLabs: chinaLabs.size,
                chinaStudents: chinaStudents.length,
                countryStats: countryStatsArray,
                unknownLabs: countryCounter.getUnknownLabs(),
                unknownStudents: countryCounter.getUnknownStudents()
            });

            return {
                totalLabs: labs.size,
                totalStudents: students.size,
                totalCountries: countryCounter.getTotalCountries(),
                chinaLabs: chinaLabs.size,
                chinaStudents: chinaStudents.length,
                chinaLabList: chinaLabList,
                chinaStudentsList: chinaStudents,
                countryStats: countryStatsArray,
                unknownLabs: countryCounter.getUnknownLabs(),
                unknownStudents: countryCounter.getUnknownStudents(),
                unknownCount: countryCounter.getUnknownCount()
            };
        }

        function displayStats(analysis) {
            document.getElementById('totalLabs').textContent = analysis.totalLabs;
            document.getElementById('totalStudents').textContent = analysis.totalStudents;
            document.getElementById('totalCountries').textContent = analysis.totalCountries;
            document.getElementById('chinaLabs').textContent = analysis.chinaLabs;
            document.getElementById('chinaStudents').textContent = analysis.chinaStudents;
            document.getElementById('stats').style.display = 'grid';
            
            // æ˜¾ç¤ºå„å›½ç»Ÿè®¡è¡¨æ ¼
            displayCountryStats(analysis.countryStats);
        }

        function displayCountryStats(countryStats) {
            const countryStatsTableBody = document.querySelector('#countryStatsTable tbody');
            countryStatsTableBody.innerHTML = '';
            
            const totalStudents = countryStats.reduce((sum, item) => sum + item.count, 0);
            
            countryStats.forEach((item, index) => {
                const row = document.createElement('tr');
                const percentage = ((item.count / totalStudents) * 100).toFixed(1);
                const labCount = item.labs ? item.labs.length : 0;
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.country}</td>
                    <td>${item.count}</td>
                    <td>${labCount}</td>
                    <td>${percentage}%</td>
                `;
                countryStatsTableBody.appendChild(row);
            });
            
            document.getElementById('countryStats').style.display = 'block';
        }

        function displayTables(analysis) {
            // æ˜¾ç¤ºä¸­å›½å®éªŒå®¤è¡¨æ ¼
            const labsTableBody = document.querySelector('#chinaLabsTable tbody');
            labsTableBody.innerHTML = '';
            
            analysis.chinaLabList.forEach(lab => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><a href="${lab.url}" target="_blank">${lab.name}</a></td>
                    <td>${lab.country}</td>
                `;
                labsTableBody.appendChild(row);
            });

            // æ˜¾ç¤ºä¸­å›½å­¦ç”Ÿè¡¨æ ¼
            const studentsTableBody = document.querySelector('#chinaStudentsTable tbody');
            studentsTableBody.innerHTML = '';
            
            analysis.chinaStudentsList.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><a href="${student.url}" target="_blank">${student.name}</a></td>
                    <td>${student.lab}</td>
                    <td>${student.country}</td>
                `;
                studentsTableBody.appendChild(row);
            });

            // æ˜¾ç¤ºUnknownè¯¦ç»†ä¿¡æ¯è¡¨æ ¼
            displayUnknownInfo(analysis);

            document.getElementById('tables').style.display = 'grid';
        }

        function displayUnknownInfo(analysis) {
            // æ˜¾ç¤ºå›½å®¶ç»Ÿè®¡ä¿¡æ¯åˆ°æ§åˆ¶å°
            console.log('ğŸŒ ===== å‚ä¸å›½å®¶æ•°é‡ç»Ÿè®¡ =====');
            console.log(`å‚ä¸å›½å®¶æ•°é‡: ${analysis.totalCountries}ä¸ª`);
            console.log('å›½å®¶åˆ—è¡¨:', analysis.countryStats.map(item => item.country).join(', '));
            console.log('');
            
            console.log('ğŸ“Š å„å›½è¯¦ç»†ä¿¡æ¯:');
            analysis.countryStats.forEach(item => {
                console.log(`${item.country}: ${item.count}ä¸ªå­¦ç”Ÿ, ${item.labs.length}ä¸ªå®éªŒå®¤`);
                console.log(`  å®éªŒå®¤: ${item.labs.join(', ')}`);
                console.log('');
            });
            
            // å¦‚æœæœ‰Unknownä¿¡æ¯ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯åˆ°æ§åˆ¶å°
            if (analysis.unknownLabs && analysis.unknownLabs.length > 0) {
                console.log('â“ Unknownå®éªŒå®¤ä¿¡æ¯:', analysis.unknownLabs);
                console.log('ğŸ‘¥ Unknownå­¦ç”Ÿä¿¡æ¯:', analysis.unknownStudents);
                console.log(`Unknownå®éªŒå®¤æ•°é‡: ${analysis.unknownLabs.length}`);
                console.log(`Unknownå­¦ç”Ÿæ•°é‡: ${analysis.unknownCount || analysis.unknownStudents.length}`);
            }
            
            console.log('ğŸŒ ===== å‚ä¸å›½å®¶ç»Ÿè®¡å®Œæˆ =====');
        }

        function get2021UnknownLabs() {
            // 2021å¹´å®é™…çš„46ä¸ªUnknownå®éªŒå®¤æ•°æ®ï¼Œä½¿ç”¨æ–°çš„å›½å®¶æå–é€»è¾‘
            const labs = [
                "Aalto (Espoo, Finland)",
                "AgriLab (Beauvais, France)",
                "Amsterdam - Waag (Amsterdam, Netherlands)",
                "Bangalore (Bangalore, India)",
                "Barcelona (Barcelona, Spain)",
                "Benfica (Lisboa, Portugal)",
                "Berytech (Beirut, Lebanon)",
                "Bhubaneswar STPI (Bhubaneswar, India)",
                "Chandigarh (Chandigarh, India)",
                "Charlotte Latin (Charlotte, United States)",
                "Ciudad de MÃ©xico (Ciudad de Mexico, Mexico)",
                "Dassault Systemes Lab (Walthan, United States)",
                "Digiscope (Gif-sur-Yvette, France)",
                "Dilijan (Dilijan, Armenia)",
                "ECAE (Abu Dhabi, United Arab Emirates)",
                "ESAN (Lima, Peru)",
                "Egypt (Cairo, egypt)",
                "FCT FabLab (Caparica, Portugal)",
                "HRW Bottrop (Bottrop, Germany)",
                "Incite Focus (Detroit, United States)",
                "Ingegno Maker Space (Drongen, Belgium)",
                "Insper (Sao Paulo, Brazil)",
                "Ioannina (Ioannina, Greece)",
                "Irbid (Irbid, Jordan)",
                "KAUST (Thuwal, Saudi Arabia)",
                "Kamakura (Kamakura, Japan)",
                "Kamp-Lintfort (Kamp-Lintfort, Germany)",
                "Kannai (Yokohama, Japan)",
                "Khairpur (Khairpur, Pakistan)",
                "Kochi - Kerala (Kochi, India)",
                "La Machinerie (Amiens, France)",
                "Leon (San Andres del Rabanedo, Spain)",
                "Libya (Benghazi, Libya)",
                "Lima (Lima, Peru)",
                "Lorain County Community College (Elyria, United States)",
                "Napoli (Napoles, Italy)",
                "O Shanghai (Shanghai, China)",
                "Opendot (Milan, Italy)",
                "Oulu (Oulu, Finland)",
                "PlusX Brighton Fablab (Brighton, United Kingdom)",
                "Puebla (San Andres de Cholula, Mexico)",
                "Rwanda (Kigali, Rwanda)",
                "SEDI-Cup-ct (Cartagena, spain)",
                "Santa Chiara (Siena, Italy)",
                "Singapore Polytechnic (Singapore, Singapore)",
                "TECSUP (Lima, Peru)",
                "Taipei (Taipei, Taiwan)",
                "Talents (Alkhobar, Saudi Arabia)",
                "Techworks Amman (Amman, Jordan)",
                "UAE (Dubai, United Arab Emirates)",
                "ULB (Brussels, Belgium)",
                "Ulima - Laboratorio de manufactura Fablab (Lima, Peru)",
                "Vancouver (Vancouver, Canada)",
                "Vigyan Ashram (Pune, India)",
                "Wheaton Fab Lab (Norton, United States)",
                "Yucatan (Yucatan, Mexico)",
                "ZOI (Quito, Ecuador)"
            ];
            
            return labs.map(labName => ({
                name: labName,
                country: extractCountryFromLabName(labName)
            }));
        }

        function extractCountryFromLabName(labName) {
            // ä»å®éªŒå®¤åç§°ä¸­æå–å›½å®¶ä¿¡æ¯ï¼Œæ ¼å¼ï¼š"å®éªŒå®¤ï¼ˆåŸå¸‚ï¼Œå›½å®¶ï¼‰"
            const match = labName.match(/\([^)]+\)/);
            if (match) {
                const content = match[0].slice(1, -1); // å»æ‰æ‹¬å·
                const parts = content.split(',').map(part => part.trim());
                if (parts.length > 0) {
                    let country = parts[parts.length - 1]; // è¿”å›æœ€åä¸€ä¸ªè¯
                    
                    // ä½¿ç”¨åŠ¨æ€å›½å®¶ç®¡ç†å™¨è¿›è¡Œæ ‡å‡†åŒ–
                    return countryManager.normalizeCountry(country);
                }
            }
            return "Unknown";
        }

        // åŠ¨æ€å›½å®¶ç®¡ç†ç³»ç»Ÿ
        class DynamicCountryManager {
            constructor() {
                // åŸºç¡€å›½å®¶æ˜ å°„è¡¨
                this.countryMapping = {
                    'Taipei': 'China',
                    'Taiwan': 'China', 
                    'Macao': 'China',
                    'Hongkong': 'China',
                    'Hong Kong': 'China',
                    'Macau': 'China',
                    'Chinese': 'China',
                    'PRC': 'China',
                    'People\'s Republic of China': 'China',
                    'Republic of China': 'China',
                    'ROC': 'China',
                    'Taiwan, China': 'China',
                    'Taipei, China': 'China',
                    'Hong Kong, China': 'China',
                    'Macau, China': 'China'
                };
                
                // åŠ¨æ€æ·»åŠ çš„å›½å®¶æ˜ å°„
                this.dynamicMapping = {};
                
                // å›½å®¶ç»Ÿè®¡
                this.countryStats = {};
                this.unknownCountries = new Set();
            }
            
            // æ ‡å‡†åŒ–å›½å®¶åç§°
            normalizeCountry(country) {
                if (!country) return 'Unknown';
                
                // é¦–å…ˆæ£€æŸ¥åŸºç¡€æ˜ å°„è¡¨
                if (this.countryMapping[country]) {
                    return this.countryMapping[country];
                }
                
                // æ£€æŸ¥åŠ¨æ€æ˜ å°„è¡¨
                if (this.dynamicMapping[country]) {
                    return this.dynamicMapping[country];
                }
                
                // å¦‚æœæ˜¯Unknownï¼Œè®°å½•åˆ°æœªçŸ¥å›½å®¶é›†åˆ
                if (country === 'Unknown' || country === 'unknown') {
                    this.unknownCountries.add(country);
                    return 'Unknown';
                }
                
                // æ–°å›½å®¶ï¼Œæ·»åŠ åˆ°åŠ¨æ€æ˜ å°„è¡¨
                this.dynamicMapping[country] = country;
                this.countryStats[country] = {
                    count: 0,
                    labs: new Set(),
                    students: []
                };
                
                console.log(`ğŸ†• å‘ç°æ–°å›½å®¶: ${country}`);
                return country;
            }
            
            // æ·»åŠ å®éªŒå®¤åˆ°å›½å®¶ç»Ÿè®¡
            addLabToCountry(country, labName) {
                const normalizedCountry = this.normalizeCountry(country);
                
                if (normalizedCountry !== 'Unknown') {
                    if (!this.countryStats[normalizedCountry]) {
                        this.countryStats[normalizedCountry] = {
                            count: 0,
                            labs: new Set(),
                            students: []
                        };
                    }
                    this.countryStats[normalizedCountry].labs.add(labName);
                }
                
                return normalizedCountry;
            }
            
            // æ·»åŠ å­¦ç”Ÿåˆ°å›½å®¶ç»Ÿè®¡
            addStudentToCountry(country, labName, studentName) {
                const normalizedCountry = this.normalizeCountry(country);
                
                if (normalizedCountry !== 'Unknown') {
                    if (!this.countryStats[normalizedCountry]) {
                        this.countryStats[normalizedCountry] = {
                            count: 0,
                            labs: new Set(),
                            students: []
                        };
                    }
                    this.countryStats[normalizedCountry].count++;
                    this.countryStats[normalizedCountry].students.push(studentName);
                    this.countryStats[normalizedCountry].labs.add(labName);
                }
                
                return normalizedCountry;
            }
            
            // è·å–å›½å®¶ç»Ÿè®¡
            getCountryStats() {
                const stats = {};
                for (const [country, data] of Object.entries(this.countryStats)) {
                    stats[country] = {
                        count: data.count,
                        labs: Array.from(data.labs),
                        students: data.students
                    };
                }
                return stats;
            }
            
            // è·å–æ‰€æœ‰å›½å®¶åˆ—è¡¨
            getAllCountries() {
                return Object.keys(this.countryStats);
            }
            
            // è·å–æœªçŸ¥å›½å®¶åˆ—è¡¨
            getUnknownCountries() {
                return Array.from(this.unknownCountries);
            }
            
            // æ‰“å°åŠ¨æ€æ˜ å°„è¡¨ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            printDynamicMapping() {
                console.log('ğŸ”„ åŠ¨æ€å›½å®¶æ˜ å°„è¡¨:');
                Object.entries(this.dynamicMapping).forEach(([original, normalized]) => {
                    console.log(`  ${original} -> ${normalized}`);
                });
            }
        }
        
        // åˆ›å»ºå…¨å±€å›½å®¶ç®¡ç†å™¨å®ä¾‹
        const countryManager = new DynamicCountryManager();

        // å›½å®¶ç»Ÿè®¡ç±»
        class CountryCounter {
            constructor() {
                this.countries = new Set();
                this.countryStats = {};
                this.unknownLabs = new Set();
                this.unknownStudents = [];
            }

            addCountry(country, labName = null, studentName = null) {
                // ä½¿ç”¨åŠ¨æ€å›½å®¶ç®¡ç†å™¨è¿›è¡Œæ ‡å‡†åŒ–
                const normalizedCountry = countryManager.normalizeCountry(country);
                
                // å¤„ç†Unknownå›½å®¶
                if (normalizedCountry === 'Unknown' || normalizedCountry === 'unknown') {
                    if (labName) {
                        this.unknownLabs.add(labName);
                    }
                    if (studentName) {
                        this.unknownStudents.push({
                            name: studentName,
                            lab: labName
                        });
                    }
                    
                    // å°†Unknownä¹Ÿæ·»åŠ åˆ°æ€»ç»Ÿè®¡ä¸­
                    this.countries.add(normalizedCountry);
                    if (!this.countryStats[normalizedCountry]) {
                        this.countryStats[normalizedCountry] = {
                            count: 0,
                            labs: new Set(),
                            students: []
                        };
                    }
                    this.countryStats[normalizedCountry].count++;
                    if (labName) {
                        this.countryStats[normalizedCountry].labs.add(labName);
                    }
                    if (studentName) {
                        this.countryStats[normalizedCountry].students.push(studentName);
                    }
                    
                    return 'Unknown';
                }
                
                // ä½¿ç”¨åŠ¨æ€å›½å®¶ç®¡ç†å™¨æ·»åŠ å­¦ç”Ÿå’Œå®éªŒå®¤
                if (labName) {
                    countryManager.addLabToCountry(normalizedCountry, labName);
                }
                if (studentName) {
                    countryManager.addStudentToCountry(normalizedCountry, labName, studentName);
                }
                
                this.countries.add(normalizedCountry);
                
                if (!this.countryStats[normalizedCountry]) {
                    this.countryStats[normalizedCountry] = {
                        count: 0,
                        labs: new Set(),
                        students: []
                    };
                }
                
                this.countryStats[normalizedCountry].count++;
                if (labName) {
                    this.countryStats[normalizedCountry].labs.add(labName);
                }
                if (studentName) {
                    this.countryStats[normalizedCountry].students.push(studentName);
                }
                
                return normalizedCountry;
            }

            addLab(labName, country) {
                const normalizedCountry = this.addCountry(country, labName);
                return normalizedCountry;
            }

            addStudent(studentName, labName, country) {
                const normalizedCountry = this.addCountry(country, labName, studentName);
                return normalizedCountry;
            }

            getTotalCountries() {
                return this.countries.size;
            }

            getCountriesList() {
                return Array.from(this.countries).sort();
            }

            getCountryStats() {
                const stats = {};
                for (const [country, data] of Object.entries(this.countryStats)) {
                    stats[country] = {
                        count: data.count,
                        labs: Array.from(data.labs),
                        students: data.students
                    };
                }
                return stats;
            }

            getUnknownLabs() {
                return Array.from(this.unknownLabs);
            }

            getUnknownStudents() {
                return this.unknownStudents;
            }

            getUnknownCount() {
                return this.unknownStudents.length;
            }
        }

        function getCountryStats(unknownLabsData) {
            // ç»Ÿè®¡å›½å®¶ä¿¡æ¯
            const countryStats = {};
            const countries = new Set();
            
            unknownLabsData.forEach(lab => {
                const country = lab.country;
                countries.add(country);
                
                if (!countryStats[country]) {
                    countryStats[country] = {
                        count: 0,
                        students: 0,
                        labs: []
                    };
                }
                
                countryStats[country].count++;
                countryStats[country].students += lab.studentCount;
                countryStats[country].labs.push(lab.name);
            });
            
            return {
                totalCountries: countries.size,
                countries: Array.from(countries).sort(),
                countryStats: countryStats
            };
        }

        function printUnknownInfo(analysis) {
            console.log('ğŸ” ===== Unknownå­¦ç”Ÿå’Œå®éªŒå®¤è¯¦ç»†ä¿¡æ¯ =====');
            
            // æ”¶é›†Unknownå­¦ç”Ÿä¿¡æ¯
            const unknownStudents = [];
            const unknownLabs = new Set();
            
            if (analysis.data) {
                analysis.data.forEach(student => {
                    if (student.country === 'Unknown') {
                        unknownStudents.push({
                            name: student.name || student.first + ' ' + student.last,
                            lab: student.lab || student.lab_name,
                            labId: student.lab ? generateLabId(student.lab) : (student.lab_name ? generateLabId(student.lab_name) : 'unknown'),
                            url: student.url
                        });
                        unknownLabs.add(student.lab || student.lab_name);
                    }
                });
            }
            
            // æ‰“å°Unknownå®éªŒå®¤ä¿¡æ¯
            console.log('ğŸ“‹ Unknownå®éªŒå®¤åˆ—è¡¨:');
            console.log('å®éªŒå®¤æ•°é‡:', unknownLabs.size);
            Array.from(unknownLabs).forEach((lab, index) => {
                const labId = generateLabId(lab);
                console.log(`${index + 1}. å®éªŒå®¤åç§°: "${lab}"`);
                console.log(`   ç”Ÿæˆçš„ID: "${labId}"`);
                console.log(`   å­¦ç”Ÿæ•°é‡: ${unknownStudents.filter(s => s.lab === lab).length}`);
                console.log('');
            });
            
            // æ‰“å°Unknownå­¦ç”Ÿè¯¦ç»†ä¿¡æ¯
            console.log('ğŸ‘¥ Unknownå­¦ç”Ÿè¯¦ç»†ä¿¡æ¯:');
            console.log('å­¦ç”Ÿæ€»æ•°:', unknownStudents.length);
            unknownStudents.forEach((student, index) => {
                console.log(`${index + 1}. å­¦ç”Ÿå§“å: "${student.name}"`);
                console.log(`   æ‰€å±å®éªŒå®¤: "${student.lab}"`);
                console.log(`   å®éªŒå®¤ID: "${student.labId}"`);
                console.log(`   å­¦ç”Ÿé“¾æ¥: ${student.url}`);
                console.log('');
            });
            
            // ç”Ÿæˆæ˜ å°„å»ºè®®
            console.log('ğŸ’¡ æ˜ å°„å»ºè®®:');
            console.log('è¯·åœ¨æ˜ å°„è¡¨ä¸­æ·»åŠ ä»¥ä¸‹å®éªŒå®¤æ˜ å°„:');
            Array.from(unknownLabs).forEach(lab => {
                const labId = generateLabId(lab);
                console.log(`'${labId}': 'Country', // ${lab}`);
            });
            
            console.log('ğŸ” ===== Unknownä¿¡æ¯æ‰“å°å®Œæˆ =====');
        }

        function generateLabId(labName) {
            return labName.toLowerCase().replace(/\s+/g, '').replace(/[^a-z]/g, '');
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.innerHTML = message;
            error.style.display = 'block';
        }

        function showSuccess(message) {
            const success = document.getElementById('success');
            success.textContent = message;
            success.style.display = 'block';
        }

        // useProxyå‡½æ•°å·²ç§»é™¤ï¼Œä»£ç†åŠŸèƒ½å·²é›†æˆåˆ°åˆ†ææ•°æ®æµç¨‹ä¸­

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ†æé»˜è®¤URL
        window.addEventListener('load', () => {
            setTimeout(() => {
                analyzeData();
            }, 1000);
        });
    </script>
</body>
</html> 
